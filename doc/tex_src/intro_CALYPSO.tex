\section{Introduction}
\label{section:introduction}
Calypso is a program package for magnetohydrodynamics (MHD) simulations in a rotating spherical shell for geodynamo problems. This package consists of the simulation program, preprocessing program, post processing program to generate field data for visualization programs, and several small utilities. The simulation program runs on parallel computing systems using MPI and OpenMP parallelization.

Calypso solves the equations that govern convection and magnetic-field generation in a rotating spherical shell. Flow is driven by thermal or compositional buoyancy in a Boussinesq fluid. Calypso also support various boundary conditions (e.g. fixed temperature, heat flux, composition, and compositional flux), and permits a conductive and rotatable inner core. Results are written as spherical harmonics coefficients, Gauss coefficients for the region outside of the fluid shell, and field data in Cartesian coordinate for easily visualization with a number of visualization programs.

This user guide describes the essentials of the magnetohydrodynamics theory and equations behind Calypso, and provides instructions for the configuration and execution of Calypso.

\section{History}
\label{sec:history}
Calypso has its origins in two earlier projects. One is a dynamo simulation code written by Hiroaki Matsui in 1990's using a spectral method. This code solves for the poloidal and toroidal spectral coefficients, like Calypso, but it calculates the nonlinear terms in the spectral domain using a parallelization for SMP architectures. The other project is the thermal convection version of GeoFEM, which is Finite Element Method (FEM) platform for massively parallel computational environment, originally written by Hiroshi Okuda in 2000. Under GeoFEM Project, Lee Chen developed cross sectioning, iso-surfacing, and volume rendering modules for data visualization for parallel computations.. 

Hiroaki Matsui was responsible for adding routines to GeoFEM to perform magnetohydrodynamics simulation in a rotating frame. In 2002 this code successfully performed dynamo simulations in a rotating spherical shell using insulating magnetic boundary conditions.  The following year Matsui implemented a subgrid scale (SGS) model in the FEM dynamo model in collaboration with Bruce Buffett. A module to solve for double diffusive convection was added to the FEM dynamo model by Hiroaki Matsui in 2009.

Progress in understanding the role of subgrid scale models in magnetohydrodynamic simulations relies on quantitative estimates for the transfer of energy between spatial scales. This information is most easily obtained from a spherical harmonic expansion of the simulation results, even when the simulation is performed by FEM. Hiroaki Matsui implemented the spherical harmonic transform in 2007 using a combination of MPI and OpenMP, and later included the spherical harmonic transform routines into his old dynamo code to create Calypso. Additional software in the program package for visualization is based on data formats from the FEM model. In addition, the control parameter file format is adapted from the input formats used in GeoFEM.

Calypso Ver. 1.0 supports the following features and capabilities
%
\begin{itemize}
\item Magnetohydrodynamics simulation for a Boussinesq fluid in a rotating spherical shell.
\item Convection driven by thermal and compositional buoyancy.
\item Temperature or heat flux is fixed at boundaries
\item Composition or compositional flux is fixed at boundaries
\item Non-slip or free-slip boundary conditions
\item Outside of the fluid shell is electrically insulated or pseudo vacuum boundary.
\item A conductive inner core with the same conductivity as the surrounding fluid
\item A rotating inner core driven by the magnetic and viscous torques.
\end{itemize}
%
%
\subsection{Updates for Ver 1.1}
In Version 1.1, a number of bug fixes and additional comments for Doxygen are completed. The following large bugs are fixed:
%
\begin{itemize}
\item \verb|configure| command is updated to find appropriate GNU make command. (see Section \ref{sec:requirements})
\item Label for radial grid type in the file \verb|ctl_sph_shell| \verb|raidal_grid_type_ctl| is changed to \verb|radial_grid_type_ctl|. If the old name is used in the control file, program \verb|gen_sph_grid| will crash.
\end{itemize}
%

And, the following features are implemented
\begin{itemize}
\item New ordering is used for spherical harmonics data to reduce communication time. The old version of spectrum indexing data, which is generated by \verb|gen_sph_grids| in Ver. 1.0 is also supported in Ver. 1.1.
\item Evaluation of Coriolis term is updated. Now, Adams-Gaunt integrals are evaluated in the initialization process in the simulation program \verb|sph_mhd|, so the data file for Adams-Gaunt integrals which is made by \verb|gen_sph_grids|  is not required.
\item Add a program \verb|sph_add_initial_field|. to modify existed initial field data. This program is used to modify or add new fields in spectrum data. (See Section \ref{sec:add_initial_field}.)
\item Heat and composition source terms are implemented. These source terms are fixed with time, and defined as spectrum data. The source terms are defined by using initial field generation program \\ \verb|sph_initial_field| or \verb|sph_add_initial_field|. (See section \ref{sec:sph_initial_field} and  \ref{sec:add_initial_field}.)
\item The boundary conditions for temperature and composition can be defined by using spherical harmonics coefficients. (i.e. inhomogeneous boundary conditions can be applied.) These boundary conditions are defined by using single external data file. (See Section \ref{sec:boundary_file})
\end{itemize}

%
\subsection{Updates for Ver 1.2}
In Version 1.2, the following features are implemented:
\begin{itemize}
\item To reduce the number of calculation, Legendre transform is calculated with taking account to the symmetry with respect to the equator. Time for Legendre transform is approximately half of that in Ver 1.1.
\item BLAS library can be used for the Legendre transform optionally.
\item Cross sectioning and isosurfacing module are newly implemented. These modules are re-written by Fortran90 from the parallel sectioning modules in GeoFEM by Lee Chen in C, and some features are added for visualizations of geodynamo simulations. See section \ref{section:PSF} and \ref{section:ISO}.
\item Initial data assemble program \verb|assemble_mhd| is parallelized. This program can perform with any number of MPI processes, but we recommend to run the program with {\bf one} process or the same number of processes as the number of subdomains for the target configuration which is defined by \verb|num_new_domain_ctl|. See section \ref{sec:add_initial_field}.
\item The time and time step information in the restart data can be modifield by  \verb|assemble_mhd|. See section \ref{sec:add_initial_field}
\end{itemize}

\subsection{Updates for Ver 2.0}
In Version 2.0, there are a number of changes as;
\begin{itemize}
\item Start using Fortran structures to reduce global instances.
\item Using MPI-IO for data IO to generate a single date file from MPI processes
\item Include interface to zlib library (\url{https://www.zlib.net}) for data IO with data compression. zlib is pre-installed in MacOS and most of Linux distributions.
\item Calypso now support various format of data IO (ascii, binary, gzipped ascii, and gzipped binary) through MPI-IO.
\item Include spherical harmonics index generator into simulation program. Consequently, we can start program without preprocessing.
\item Modules to generate longitudinal average data is included into the simulation program.
\item Due to the performance drops on massively parallel environment, spectrum data \\
{\tt [picked\_sph\_prefix].dat} is splitted into the data files for each spherical harmonics mode {\tt [picked\_sph\_prefix]\_l[degree]\_m[order][c/s].dat}. Consequently, the file prefix [picked\_sph\_prefix] is recommends to includer subdirectory and that files are saved undere a subdirectory. (See Section \ref{sec:pickup_spectr_ctl} and tests under \verb|tests/Dynamobench_case2|.)
\item Number of array information is not required to define "array" block in control files.
\item Block layout of the control file is changed for spatial resolution and spherical harmonic data IO.
\end{itemize}






\section{Acknowledgements}
\label{section:acknowledgements}
Calypso was primarily developed by Dr. Hiroaki Matsui in collaboration with Prof. Bruce Buffett at the University of California, Berkeley. The following NSF grants supported the development of Calypso, 
%
\begin{itemize}
\item B.A. Buffett, NSF EAR-0509893; Models of sub-grid scale turbulence in the Earth's core and the geodynamo; 2005 - 2007.
\item B.A. Buffett and D. Lathrop,  NSF EAR-0652882; CSEDI Collaborative Research: Integrating numerical and experimental geodynamo models, 2007 - 2009
\item B.A. Buffett, NSF EAR-1045277; Development and application of turbulence models in numerical geodynamo simulations ;  2010 - 2012
\end{itemize}
%

\section{Citation}
\label{section:citation}

Computational Infrastructure for Geodynamics (CIG) and the Calypso developers are making the source code to Calypso available to researchers in the hope that it will aid their research and teaching. A number of individuals have contributed a significant amount of time and energy into the development of Calypso. We request that you cite the appropriate papers and make acknowledgements as necessary. The Calypso development team asks that you cite the following papers:

Matsui, H., E. King, and B.A. Buffett, Multi-scale convection in a geodynamo simulation with uniform heat flux along the outer boundary, {\it Geochemistry, Geophysics, Geosystems}, {\bf 15}, 3212 -- 3225, 2014.
